/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2022 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "impl_tsk.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <string.h>
#include <stdio.h>
#include <math.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */
#define ITM_Port32(n) (*((volatile unsigned long *)(0xE0000000+4*n)))
/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
 ADC_HandleTypeDef hadc1;
ADC_HandleTypeDef hadc2;

TIM_HandleTypeDef htim3;
TIM_HandleTypeDef htim4;
TIM_HandleTypeDef htim5;
TIM_HandleTypeDef htim9;

UART_HandleTypeDef huart3;

/* USER CODE BEGIN PV */


///////////////////////motor_fxn///////////////////
int P_wm_m1=0;
int P_wm_m2=0;
////////th///////////////////
volatile float raw_enc1=0;
volatile float raw_enc2=0;


volatile float prev_enc1=32767;
volatile float prev_enc2=32767;

volatile float real_enc1=0;
volatile float real_enc2=0;

float eth1=0;
float eth2=0;
float th1=0;
float th2=0;

float spth1=0;
float spth2=0;


float DE_rrorm1=0;
float prev_th1=0;
float vel_DError_d1=0;

float DE_rrorm2=0;
float prev_th2=0;
float vel_DError_d2=0;
/////////th dot//////////////////
/////////////////////////time_var/////////////////////
double prev_time=0;
double now_time=0;
float D_t=1E-6;
double timeblock=65535;

////////////////////kalman_dot1////////////
//Kalman Variable3
volatile float measurement3=0;
volatile float estimate3=0;
volatile float measurement_variance3=0.5;
volatile float estimate_variance3=0.3;
volatile float estimate_measurement_weight3=0.001;
volatile float kalman_gain3;
volatile float old_estimate3;

////////////////////kalman_dot2////////////
//Kalman Variable4
volatile float measurement4=0;
volatile float estimate4=0;
volatile float measurement_variance4=0.5;
volatile float estimate_variance4=0.3;
volatile float estimate_measurement_weight4=0.001;
volatile float kalman_gain4;
volatile float old_estimate4;



///////////////////////motor_fxn///////////////////
///////////////////////array_var///////////////////
float data=0;
int arr_indx=0;
///////////////////////array_var///////////////////
////////////////////////current_var////////////////////
//acs var
 uint16_t raw;
 float current=0;
 float volt=0;
 float inivolt=0;

 //Kalman Variable
 volatile float measurement=0;
 volatile float estimate=0;
 volatile float measurement_variance=0.5;
 volatile float estimate_variance=0.3;
 volatile float estimate_measurement_weight=0.001;
 volatile float kalman_gain;
 volatile float old_estimate;

 //loop var
 float E_rror_m1=0;
 float D_current = 0;
 float kp =1500;

 //acs var2
 uint16_t raw2;
 float current2=0;
 float volt2=0;
 float inivolt2=0;

 //Kalman Variable2
 volatile float measurement2=0;
 volatile float estimate2=0;
 volatile float measurement_variance2=0.5;
 volatile float estimate_variance2=0.3;
 volatile float estimate_measurement_weight2=0.001;
 volatile float kalman_gain2;
 volatile float old_estimate2;

 //loop var2
 float E_rror_m2=0;
 float D_current2 = 0;
 float kp2 =1500;
 ////////////////////////current_var////////////////////


 /////////////////////////trac_ implementation/////////////////////////
 float thd1_trac[500]={1.57075092686252,1.57074907405733,1.57074714563651,1.57074513851526,1.57074304948251,1.57074087519520,1.57073861217083,1.57073625679341,1.57073380529095,1.57073125373955,1.57072859805754,1.57072583399559,1.57072295713024,1.57071996285744,1.57071684638505,1.57071360272901,1.57071022669620,1.57070671288478,1.57070305567081,1.57069924920418,1.57069528739284,1.57069116389739,1.57068687211782,1.57068240518802,1.57067775595861,1.57067291699104,1.57066788054204,1.57066263855082,1.57065718262999,1.57065150404928,1.57064559372116,1.57063944218739,1.57063303960583,1.57062637572929,1.57061943989486,1.57061222100386,1.57060470750419,1.57059688737313,1.57058874809603,1.57058027664893,1.57057145947596,1.57056228246642,1.57055273093722,1.57054278960229,1.57053244255381,1.57052167323426,1.57051046441068,1.57049879814637,1.57048665577298,1.57047401786005,1.57046086418418,1.57044717369672,1.57043292449037,1.57041809376283,1.57040265778206,1.57038659184722,1.57036987024963,1.57035246623095,1.57033435194111,1.57031549839372,1.57029587541896,1.57027545161558,1.57025419430198,1.57023206946166,1.57020904169010,1.57018507413837,1.57016012845335,1.57013416471673,1.57010714138110,1.57007901520394,1.57004974117715,1.57001927245672,1.56998756028615,1.56995455391990,1.56992020054083,1.56988444517691,1.56984723061216,1.56980849729609,1.56976818324781,1.56972622395688,1.56968255228020,1.56963709833497,1.56958978938599,1.56954054972990,1.56948930057434,1.56943595991121,1.56938044238549,1.56932265915932,1.56926251776939,1.56919992197896,1.56913477162413,1.56906696245354,1.56899638596140,1.56892292921420,1.56884647466977,1.56876689998951,1.56868407784248,1.56859787570185,1.56850815563293,1.56841477407231,1.56831758159861,1.56821642269318,1.56811113549173,1.56800155152504,1.56788749544989,1.56776878476855,1.56764522953713,1.56751663206160,1.56738278658203,1.56724347894355,1.56709848625398,1.56694757652761,1.56679050831466,1.56662703031510,1.56645688097741,1.56627978808068,1.56609546829964,1.56590362675234,1.56570395652917,1.56549613820291,1.56527983931878,1.56505471386393,1.56482040171532,1.56457652806533,1.56432270282388,1.56405851999664,1.56378355703787,1.56349737417731,1.56319951371956,1.56288949931557,1.56256683520449,1.56223100542505,1.56188147299536,1.56151767905951,1.56113904200018,1.56074495651547,1.56033479265896,1.55990789484141,1.55946358079256,1.55900114048171,1.55851983499557,1.55801889537136,1.55749752138411,1.55695488028608,1.55639010549663,1.55580229524094,1.55519051113546,1.55455377671866,1.55389107592467,1.55320135149841,1.55248350334989,1.55173638684586,1.55095881103685,1.55014953681746,1.54930727501814,1.54843068442617,1.54751836973418,1.54656887941408,1.54558070351457,1.54455227138044,1.54348194929203,1.54236803802304,1.54120877031545,1.54000230827018,1.53874674065236,1.53744008011057,1.53608026030935,1.53466513297496,1.53319246485459,1.53165993458974,1.53006512950516,1.52840554231520,1.52667856775034,1.52488149910740,1.52301152472805,1.52106572441121,1.51904106576630,1.51693440051577,1.51474246075694,1.51246185519506,1.51008906536170,1.50762044183479,1.50505220047957,1.50238041873248,1.49960103195364,1.49670982987721,1.49370245319331,1.49057439029978,1.48732097426755,1.48393738006909,1.48041862212599,1.47675955223906,1.47295485797202,1.46899906156889,1.46488651949455,1.46061142269863,1.45616779771403,1.45154950871405,1.44675026066506,1.44176360372623,1.43658293906294,1.43120152625642,1.42561249250937,1.41980884386439,1.41378347867040,1.40752920354986,1.40103875213790,1.39430480688130,1.38732002420151,1.38007706333982,1.37256861921394,1.36478745962293,1.35672646713944,1.34837868602446,1.33973737448754,1.33079606259323,1.32154861608085,1.31198930631639,1.30211288653079,1.29191467441528,1.28139064103974,1.27053750593134,1.25935283799665,1.24783516178886,1.23598406841256,1.22380033012121,1.21128601739868,1.19844461702986,1.18528114936012,1.17180228262793,1.15801644193876,1.14393391014376,1.12956691760985,1.11492971763597,1.10003864410375,1.08491214787107,1.06957080844593,1.05403731763514,1.03833643216741,1.02249489275408,1.00654130768130,0.990505999821482,0.974420816896740,0.958318905899279,0.942234453737187,0.926202397382329,0.910258107994362,0.894437054619184,0.878774454047137,0.863304914203981,0.848062078981481,0.833078282651806,0.818384221924844,0.804008653292862,0.789978122576586,0.776316732574452,0.763045953474309,0.750184479279871,0.737748132007346,0.725749813898551,0.714199506450323,0.703104313743144,0.692468546419117,0.682293841750218,0.672579314575101,0.663321733473019,0.654515716378385,0.646153939898175,0.638227356846410,0.630725416918982,0.623636285958860,0.616947059866931,0.610643969860789,0.604712576439947,0.599137950054059,0.593904837069347,0.588997810171929,0.584401402825137,0.580100227806035,0.576079080183015,0.572323025363898,0.568817473046770,0.565548238050182,0.562501589092407,0.559664286638731,0.557023610948797,0.554567381439901,0.552283968443510,0.550162298376856,0.548191853284502,0.546362665630325,0.544665309142217,0.543090886432516,0.541631014039192,0.540277805457547,0.539023852661035,0.537862206543339,0.536786356652738,0.535790210534070,0.534868072943452,0.534014625156072,0.533224904547713,0.532494284595789,0.531818455415343,0.531193404919157,0.530615400668621,0.530080972462805,0.529586895696985,0.529130175508307,0.528708031715063,0.528317884546805,0.527957341155097,0.527624182888760,0.527316353312819,0.527031946946817,0.526769198695578,0.526526473943641,0.526302259283473,0.526095153846877,0.525903861208875,0.525727181833500,0.525564006031370,0.525413307399636,0.525274136715707,0.525145616257192,0.525026934521522,0.524917341319905,0.524816143221412,0.524722699324224,0.524636417332234,0.524556749916415,0.524483191341525,0.524415274339846,0.524352567214774,0.524294671158118,0.524241217765991,0.524191866739155,0.524146303754592,0.524104238495952,0.524065402831369,0.524029549127902,0.523996448692623,0.523965890331026,0.523937679014131,0.523911634646221,0.523887590925768,0.523865394292590,0.523844902954826,0.523825985989746,0.523808522512869,0.523792400910257,0.523777518129232,0.523763779023115,0.523751095745900,0.523739387193109,0.523728578485302,0.523718600491041,0.523709389386289,0.523700886247494,0.523693036675787,0.523685790449932,0.523679101205839,0.523672926140605,0.523667225739232,0.523661963522274,0.523657105812823,0.523652621521353,0.523648481947066,0.523644660594463,0.523641133003991,0.523637876595674,0.523634870524754,0.523632095548394,0.523629533902622,0.523627169188722,0.523624986268337,0.523622971166637,0.523621110982913,0.523619393808043,0.523617808648295,0.523616345354981,0.523614994559517,0.523613747613468,0.523612596533203,0.523611533948799,0.523610553056873,0.523609647577037,0.523608811711698,0.523608040108950,0.523607327828314,0.523606670309117,0.523606063341290,0.523605503038423,0.523604985812883,0.523604508352847,0.523604067601098,0.523603660735457,0.523603285150709,0.523602938441926,0.523602618389074,0.523602322942792,0.523602050211276,0.523601798448165,0.523601566041358,0.523601351502699,0.523601153458436,0.523600970640441,0.523600801878075,0.523600646090703,0.523600502280771,0.523600369527419,0.523600246980585,0.523600133855561,0.523600029427969,0.523599933029124,0.523599844041751,0.523599761896032,0.523599686065958,0.523599616065963,0.523599551447810,0.523599491797727,0.523599436733751,0.523599385903286,0.523599338980847,0.523599295665971,0.523599255681296,0.523599218770785,0.523599184698085,0.523599153245016,0.523599124210171,0.523599097407629,0.523599072665763,0.523599049826140,0.523599028742509,0.523599009279864,0.523598991313577,0.523598974728603,0.523598959418742,0.523598945285958,0.523598932239754,0.523598920196589,0.523598909079346,0.523598898816837,0.523598889343347,0.523598880598214,0.523598872525438,0.523598865073326,0.523598858194160,0.523598851843889,0.523598845981850,0.523598840570506,0.523598835575206,0.523598830963963,0.523598826707248,0.523598822777806,0.523598819150473,0.523598815802023,0.523598812711014,0.523598809857653,0.523598807223669,0.523598804792195,0.523598802547662,0.523598800475696,0.523598798563031,0.523598796797419,0.523598795167553,0.523598793662997,0.523598792274117,0.523598790992019,0.523598789808494,0.523598788715962,0.523598787707428,0.523598786776434,0.523598785917018,0.523598785123677,0.523598784391332,0.523598783715291,0.523598783091227,0.523598782515143,0.523598781983351,0.523598781492445,0.523598781039282,0.523598780620959,0.523598780234798,0.523598779878328,0.523598779549263,0.523598779245499,0.523598778965089,0.523598778706238,0.523598778467288,0.523598778246709,0.523598778043090,0.523598777855125,0.523598777681612,0.523598777521440,0.523598777373582,0.523598777237091,0.523598777111095,0.523598776994786,0.523598776887419};
 float thd2_trac[500]={9.07998647601927e-05,9.45054751295877e-05,9.83623167648648e-05,0.000102376559264912,0.000106554624783252,0.000110903199402044,0.000115429248123638,0.000120140002981189,0.000125043007894024,0.000130146110696835,0.000135457474708482,0.000140985598614069,0.000146739329308712,0.000152727874922454,0.000158960819703410,0.000165448131769932,0.000172200197387175,0.000179227820233558,0.000186542248169118,0.000194155181426224,0.000202078804104533,0.000210325795022985,0.000218909354157547,0.000227843213756664,0.000237141672573736,0.000246819607714657,0.000256892505704263,0.000267376488157032,0.000278288329810308,0.000289645491234029,0.000301466147481482,0.000313769215008031,0.000326574378134266,0.000339902131211319,0.000353773800069311,0.000368211582065028,0.000383238581422256,0.000398878843536015,0.000415157397723391,0.000432100291926402,0.000449734637867880,0.000468088656962495,0.000487191715361568,0.000507074385222307,0.000527768482165908,0.000549307121275444,0.000571724768425522,0.000595057297059890,0.000619342043841386,0.000644617869702473,0.000670925221438691,0.000698306196352369,0.000726804609045091,0.000756466064138174,0.000787338025672267,0.000819469895345820,0.000852913090533813,0.000887721127886972,0.000923949707577079,0.000961656802360474,0.00100090275187644,0.00104175035863151,0.00108426498583297,0.00112851466647265,0.00117457020960102,0.00122250531304474,0.00127239668308357,0.00132432415634315,0.00137837082758854,0.00143462318191937,0.00149317123548616,0.00155410867635782,0.00161753301749484,0.00168354574999301,0.00175225250814231,0.00182376323596947,0.00189819236548127,0.00197565899760703,0.00205628709418193,0.00214020567603033,0.00222754902938771,0.00231845691986141,0.00241307481781288,0.00251155412999962,0.00261405244110367,0.00272073376736751,0.00283176881880775,0.00294733527114642,0.00306761805100358,0.00319280963186838,0.00332311034153458,0.00345872868270648,0.00359988166699871,0.00374679516139182,0.00389970425024570,0.00405885361077216,0.00422449790482443,0.00439690218609436,0.00457634232392353,0.00476310544516836,0.00495749039257109,0.00515980820343524,0.00537038260633759,0.00558955053971894,0.00581766269001152,0.00605508405268481,0.00630219451553520,0.00655938946658930,0.00682708042572799,0.00710569570269677,0.00739568108183946,0.00769750053456727,0.00801163696048195,0.00833859295960208,0.00867889163497088,0.00903307742842359,0.00940171699051073,0.00978540008510898,0.0101847405314468,0.0106003771839785,0.0110329749522312,0.0114832258619409,0.0119518501591466,0.0124395974591285,0.0129472479420327,0.0134756135965211,0.0140255395140457,0.0145979052351781,0.0151936261506777,0.0158136549586491,0.0164589831808126,0.0171306427396862,0.0178297075990718,0.0185572954707784,0.0193145695894299,0.0201027405588556,0.0209230682718713,0.0217768639069699,0.0226654920046768,0.0235903726263665,0.0245529835986441,0.0255548628470745,0.0265976108215772,0.0276828930176415,0.0288124425965351,0.0299880631079185,0.0312116313188728,0.0324851001524815,0.0338105017404585,0.0351899505929796,0.0366256468900167,0.0381198798980758,0.0396750315161006,0.0412935799548731,0.0429781035535165,0.0447312847374607,0.0465559141214253,0.0484548947616255,0.0504312465606499,0.0524881108289082,0.0546287550057406,0.0568565775437173,0.0591751129588847,0.0615880370494280,0.0640991722850646,0.0667124933686483,0.0694321329710952,0.0722623876398705,0.0752077238806152,0.0782727844103182,0.0814623945794733,0.0847815689593910,0.0882355180891146,0.0918296553749939,0.0955696041336959,0.0994612047673720,0.103510522057191,0.107723852558252,0.112107732075914,0.116668943199665,0.121414522866390,0.126351769920208,0.131488252630652,0.136831816124839,0.142390589682522,0.148172993835375,0.154187747203173,0.160443872990231,0.166950705054686,0.173717893451622,0.180755409337821,0.188073549111680,0.195682937645752,0.203594530452014,0.211819614600690,0.220369808192541,0.229257058161732,0.238493636161691,0.248092132259682,0.258065446137336,0.268426775463921,0.279189601076956,0.290367668571062,0.301974965861017,0.314025696249001,0.326534246490078,0.339515149313997,0.352983039827201,0.366952605186771,0.381438526910154,0.396455415161906,0.412017734343930,0.428139719310923,0.444835281540869,0.462117904614704,0.480000528403334,0.498495421428098,0.517614040957005,0.537366880528204,0.557763304759230,0.578811371510320,0.600517641727111,0.622886977596492,0.645922330012082,0.669624516764669,0.693991993347374,0.719020618792436,0.744703419530068,0.771030354869548,0.797988088333925,0.825559769712271,0.853724833302281,0.882458818370101,0.911733218317848,0.941515365382303,0.971768357847651,1.00245103669794,1.03351801831951,1.06491978925497,1.09660286808163,1.12851003822720,1.16058065394683,1.19275101979631,1.22495484179123,1.25712374611542,1.28918785882514,1.32107643760107,1.35271854435142,1.38404374549552,1.41498282518183,1.44546849562683,1.47543608828618,1.50482420974010,1.53357534700407,1.56163640843662,1.58895918844089,1.61550074664117,1.64122369503005,1.66609638957510,1.69009302579269,1.71319364068915,1.73538402610350,1.75665556075156,1.77700497008936,1.79643402443959,1.81494918664375,1.83256122083302,1.84928477379344,1.86513793989697,1.88014181975183,1.89432008167207,1.90769853385593,1.92030471386822,1.93216750070990,1.94331675348168,1.95378297945110,1.96359703324594,1.97278984793952,1.98139219797772,1.98943449322376,1.99694660286200,2.00395770749625,2.01049617748943,2.01658947540498,2.02226408031233,2.02754543169220,2.03245789070999,2.03702471670277,2.04126805683608,2.04520894702079,2.04886732232914,2.05226203530536,2.05541088072476,2.05833062551141,2.06103704267470,2.06354494826772,2.06586824050312,2.06801994028432,2.07001223252165,2.07185650770289,2.07356340327765,2.07514284449437,2.07660408439822,2.07795574275911,2.07920584375148,2.08036185225255,2.08143070866418,2.08241886219582,2.08333230257318,2.08417659015967,2.08495688449618,2.08567797127960,2.08634428781227,2.08695994696416,2.08752875969616,2.08805425619864,2.08853970570251,2.08898813502285,2.08940234589604,2.08978493117204,2.09013828992279,2.09046464152705,2.09076603879052,2.09104438015838,2.09130142107541,2.09153878454675,2.09175797094998,2.09196036714697,2.09214725494134,2.09231981892532,2.09247915375696,2.09262627090674,2.09276210491010,2.09288751916024,2.09300331127356,2.09311021805781,2.09320892011148,2.09330004608061,2.09338417659789,2.09346184792706,2.09353355533399,2.09359975620455,2.09366087292774,2.09371729556153,2.09376938429735,2.09381747173826,2.09386186500461,2.09390284768014,2.09394068161030,2.09397560856406,2.09400785176928,2.09403761733133,2.09406509554356,2.09409046209799,2.09411387920358,2.09413549661919,2.09415545260771,2.09417387481721,2.09419088109481,2.09420658023822,2.09422107268993,2.09423445117812,2.09424680130858,2.09425820211133,2.09426872654525,2.09427844196415,2.09428741054709,2.09429568969566,2.09430333240087,2.09431038758181,2.09431690039844,2.09432291254028,2.09432846249301,2.09433358578455,2.09433831521235,2.09434268105312,2.09434671125652,2.09435043162397,2.09435386597371,2.09435703629320,2.09435996287983,2.09436266447076,2.09436515836286,2.09436746052339,2.09436958569220,2.09437154747605,2.09437335843572,2.09437503016640,2.09437657337189,2.09437799793316,2.09437931297156,2.09438052690721,2.09438164751295,2.09438268196403,2.09438363688410,2.09438451838760,2.09438533211888,2.09438608328838,2.09438677670594,2.09438741681165,2.09438800770421,2.09438855316724,2.09438905669346,2.09438952150708,2.09438995058440,2.09439034667292,2.09439071230891,2.09439104983364,2.09439136140839,2.09439164902825,2.09439191453495,2.09439215962862,2.09439238587867,2.09439259473386,2.09439278753155,2.09439296550629,2.09439312979773,2.09439328145788,2.09439342145787,2.09439355069417,2.09439366999434,2.09439378012229,2.09439388178322,2.09439397562810,2.09439406225785,2.09439414222720,2.09439421604822,2.09439428419362,2.09439434709976,2.09439440516945,2.09439445877454,2.09439450825827,2.09439455393751,2.09439459610478,2.09439463503007,2.09439467096264,2.09439470413259,2.09439473475231,2.09439476301788,2.09439478911029,2.09439481319662,2.09439483543110,2.09439485595612,2.09439487490310,2.09439489239337,2.09439490853892,2.09439492344314,2.09439493720147,2.09439494990201,2.09439496162609,2.09439497244878,2.09439498243938,2.09439499166187,2.09439500017530,2.09439500803418,2.09439501528885,2.09439502198575,2.09439502816777,2.09439503387449,2.09439503914246,2.09439504400540,2.09439504849447,2.09439505263840,2.09439505646373,2.09439505999496,2.09439506325469,2.09439506626380,2.09439506904156,2.09439507160575,2.09439507397281,2.09439507615787,2.09439507817494,2.09439508003692,2.09439508175576,2.09439508334244,2.09439508480713,2.09439508615921,2.09439508740734,2.09439508855951,2.09439508962309,2.09439509060490,2.09439509151123,2.09439509234788,2.09439509312020,2.09439509383314,2.09439509449127,2.09439509509880,2.09439509565962,2.09439509617732,2.09439509665522,2.09439509709637,2.09439509750361,2.09439509787954,2.09439509822657,2.09439509854691,2.09439509884263,2.09439509911561,2.09439509936760,2.09439509960022,2.09439509981496};
 float trac_tvect[500]={0,0.00200000000000000,0.00400000000000000,0.00600000000000000,0.00800000000000000,0.0100000000000000,0.0120000000000000,0.0140000000000000,0.0160000000000000,0.0180000000000000,0.0200000000000000,0.0220000000000000,0.0240000000000000,0.0260000000000000,0.0280000000000000,0.0300000000000000,0.0320000000000000,0.0340000000000000,0.0360000000000000,0.0380000000000000,0.0400000000000000,0.0420000000000000,0.0440000000000000,0.0460000000000000,0.0480000000000000,0.0500000000000000,0.0520000000000000,0.0540000000000000,0.0560000000000000,0.0580000000000000,0.0600000000000000,0.0620000000000000,0.0640000000000000,0.0660000000000000,0.0680000000000000,0.0700000000000000,0.0720000000000000,0.0740000000000000,0.0760000000000000,0.0780000000000000,0.0800000000000000,0.0820000000000000,0.0840000000000000,0.0860000000000000,0.0880000000000000,0.0900000000000000,0.0920000000000000,0.0940000000000000,0.0960000000000000,0.0980000000000000,0.100000000000000,0.102000000000000,0.104000000000000,0.106000000000000,0.108000000000000,0.110000000000000,0.112000000000000,0.114000000000000,0.116000000000000,0.118000000000000,0.120000000000000,0.122000000000000,0.124000000000000,0.126000000000000,0.128000000000000,0.130000000000000,0.132000000000000,0.134000000000000,0.136000000000000,0.138000000000000,0.140000000000000,0.142000000000000,0.144000000000000,0.146000000000000,0.148000000000000,0.150000000000000,0.152000000000000,0.154000000000000,0.156000000000000,0.158000000000000,0.160000000000000,0.162000000000000,0.164000000000000,0.166000000000000,0.168000000000000,0.170000000000000,0.172000000000000,0.174000000000000,0.176000000000000,0.178000000000000,0.180000000000000,0.182000000000000,0.184000000000000,0.186000000000000,0.188000000000000,0.190000000000000,0.192000000000000,0.194000000000000,0.196000000000000,0.198000000000000,0.200000000000000,0.202000000000000,0.204000000000000,0.206000000000000,0.208000000000000,0.210000000000000,0.212000000000000,0.214000000000000,0.216000000000000,0.218000000000000,0.220000000000000,0.222000000000000,0.224000000000000,0.226000000000000,0.228000000000000,0.230000000000000,0.232000000000000,0.234000000000000,0.236000000000000,0.238000000000000,0.240000000000000,0.242000000000000,0.244000000000000,0.246000000000000,0.248000000000000,0.250000000000000,0.252000000000000,0.254000000000000,0.256000000000000,0.258000000000000,0.260000000000000,0.262000000000000,0.264000000000000,0.266000000000000,0.268000000000000,0.270000000000000,0.272000000000000,0.274000000000000,0.276000000000000,0.278000000000000,0.280000000000000,0.282000000000000,0.284000000000000,0.286000000000000,0.288000000000000,0.290000000000000,0.292000000000000,0.294000000000000,0.296000000000000,0.298000000000000,0.300000000000000,0.302000000000000,0.304000000000000,0.306000000000000,0.308000000000000,0.310000000000000,0.312000000000000,0.314000000000000,0.316000000000000,0.318000000000000,0.320000000000000,0.322000000000000,0.324000000000000,0.326000000000000,0.328000000000000,0.330000000000000,0.332000000000000,0.334000000000000,0.336000000000000,0.338000000000000,0.340000000000000,0.342000000000000,0.344000000000000,0.346000000000000,0.348000000000000,0.350000000000000,0.352000000000000,0.354000000000000,0.356000000000000,0.358000000000000,0.360000000000000,0.362000000000000,0.364000000000000,0.366000000000000,0.368000000000000,0.370000000000000,0.372000000000000,0.374000000000000,0.376000000000000,0.378000000000000,0.380000000000000,0.382000000000000,0.384000000000000,0.386000000000000,0.388000000000000,0.390000000000000,0.392000000000000,0.394000000000000,0.396000000000000,0.398000000000000,0.400000000000000,0.402000000000000,0.404000000000000,0.406000000000000,0.408000000000000,0.410000000000000,0.412000000000000,0.414000000000000,0.416000000000000,0.418000000000000,0.420000000000000,0.422000000000000,0.424000000000000,0.426000000000000,0.428000000000000,0.430000000000000,0.432000000000000,0.434000000000000,0.436000000000000,0.438000000000000,0.440000000000000,0.442000000000000,0.444000000000000,0.446000000000000,0.448000000000000,0.450000000000000,0.452000000000000,0.454000000000000,0.456000000000000,0.458000000000000,0.460000000000000,0.462000000000000,0.464000000000000,0.466000000000000,0.468000000000000,0.470000000000000,0.472000000000000,0.474000000000000,0.476000000000000,0.478000000000000,0.480000000000000,0.482000000000000,0.484000000000000,0.486000000000000,0.488000000000000,0.490000000000000,0.492000000000000,0.494000000000000,0.496000000000000,0.498000000000000,0.500000000000000,0.502000000000000,0.504000000000000,0.506000000000000,0.508000000000000,0.510000000000000,0.512000000000000,0.514000000000000,0.516000000000000,0.518000000000000,0.520000000000000,0.522000000000000,0.524000000000000,0.526000000000000,0.528000000000000,0.530000000000000,0.532000000000000,0.534000000000000,0.536000000000000,0.538000000000000,0.540000000000000,0.542000000000000,0.544000000000000,0.546000000000000,0.548000000000000,0.550000000000000,0.552000000000000,0.554000000000000,0.556000000000000,0.558000000000000,0.560000000000000,0.562000000000000,0.564000000000000,0.566000000000000,0.568000000000000,0.570000000000000,0.572000000000000,0.574000000000000,0.576000000000000,0.578000000000000,0.580000000000000,0.582000000000000,0.584000000000000,0.586000000000000,0.588000000000000,0.590000000000000,0.592000000000000,0.594000000000000,0.596000000000000,0.598000000000000,0.600000000000000,0.602000000000000,0.604000000000000,0.606000000000000,0.608000000000000,0.610000000000000,0.612000000000000,0.614000000000000,0.616000000000000,0.618000000000000,0.620000000000000,0.622000000000000,0.624000000000000,0.626000000000000,0.628000000000000,0.630000000000000,0.632000000000000,0.634000000000000,0.636000000000000,0.638000000000000,0.640000000000000,0.642000000000000,0.644000000000000,0.646000000000000,0.648000000000000,0.650000000000000,0.652000000000000,0.654000000000000,0.656000000000000,0.658000000000000,0.660000000000000,0.662000000000000,0.664000000000000,0.666000000000000,0.668000000000000,0.670000000000000,0.672000000000000,0.674000000000000,0.676000000000000,0.678000000000000,0.680000000000000,0.682000000000000,0.684000000000000,0.686000000000000,0.688000000000000,0.690000000000000,0.692000000000000,0.694000000000000,0.696000000000000,0.698000000000000,0.700000000000000,0.702000000000000,0.704000000000000,0.706000000000000,0.708000000000000,0.710000000000000,0.712000000000000,0.714000000000000,0.716000000000000,0.718000000000000,0.720000000000000,0.722000000000000,0.724000000000000,0.726000000000000,0.728000000000000,0.730000000000000,0.732000000000000,0.734000000000000,0.736000000000000,0.738000000000000,0.740000000000000,0.742000000000000,0.744000000000000,0.746000000000000,0.748000000000000,0.750000000000000,0.752000000000000,0.754000000000000,0.756000000000000,0.758000000000000,0.760000000000000,0.762000000000000,0.764000000000000,0.766000000000000,0.768000000000000,0.770000000000000,0.772000000000000,0.774000000000000,0.776000000000000,0.778000000000000,0.780000000000000,0.782000000000000,0.784000000000000,0.786000000000000,0.788000000000000,0.790000000000000,0.792000000000000,0.794000000000000,0.796000000000000,0.798000000000000,0.800000000000000,0.802000000000000,0.804000000000000,0.806000000000000,0.808000000000000,0.810000000000000,0.812000000000000,0.814000000000000,0.816000000000000,0.818000000000000,0.820000000000000,0.822000000000000,0.824000000000000,0.826000000000000,0.828000000000000,0.830000000000000,0.832000000000000,0.834000000000000,0.836000000000000,0.838000000000000,0.840000000000000,0.842000000000000,0.844000000000000,0.846000000000000,0.848000000000000,0.850000000000000,0.852000000000000,0.854000000000000,0.856000000000000,0.858000000000000,0.860000000000000,0.862000000000000,0.864000000000000,0.866000000000000,0.868000000000000,0.870000000000000,0.872000000000000,0.874000000000000,0.876000000000000,0.878000000000000,0.880000000000000,0.882000000000000,0.884000000000000,0.886000000000000,0.888000000000000,0.890000000000000,0.892000000000000,0.894000000000000,0.896000000000000,0.898000000000000,0.900000000000000,0.902000000000000,0.904000000000000,0.906000000000000,0.908000000000000,0.910000000000000,0.912000000000000,0.914000000000000,0.916000000000000,0.918000000000000,0.920000000000000,0.922000000000000,0.924000000000000,0.926000000000000,0.928000000000000,0.930000000000000,0.932000000000000,0.934000000000000,0.936000000000000,0.938000000000000,0.940000000000000,0.942000000000000,0.944000000000000,0.946000000000000,0.948000000000000,0.950000000000000,0.952000000000000,0.954000000000000,0.956000000000000,0.958000000000000,0.960000000000000,0.962000000000000,0.964000000000000,0.966000000000000,0.968000000000000,0.970000000000000,0.972000000000000,0.974000000000000,0.976000000000000,0.978000000000000,0.980000000000000,0.982000000000000,0.984000000000000,0.986000000000000,0.988000000000000,0.990000000000000,0.992000000000000,0.994000000000000,0.996000000000000,0.998000000000000};
 float thd1=0;
 float thd2=0;
 int flag=0;

 float t1ini=0;
 float t2ini=0;
 float t1fi=0;
 float t2fi=0;
 //*********velocity desired arry***********//
 float vel_track_d1[500]={-0.000463201296152516,-0.000482105204424599,-0.000501780312467393,-0.000522258189805669,-0.000543571827382738,-0.000565756090198377,-0.000588844357163332,-0.000612875614092179,-0.000637887850374330,-0.000663920501464688,-0.000691015488163416,-0.000719216336875217,-0.000748568201702771,-0.000779118097593567,-0.000810914008331221,-0.000844008202161017,-0.000878452855790357,-0.000914303491972301,-0.000951616657141052,-0.000990452834748190,-0.00103087386482681,-0.00107294489182230,-0.00111673244990174,-0.00116230735214273,-0.00120974189260492,-0.00125911224868602,-0.00131049780660586,-0.00136398020667006,-0.00141964517796911,-0.00147758203089543,-0.00153788344081640,-0.00160064539078686,-0.00166596913464545,-0.00173395860725289,-0.00180472274946553,-0.00187837491966159,-0.00195503276417819,-0.00203481927346649,-0.00211786177534146,-0.00220429324271354,-0.00229425238679193,-0.00238788229989240,-0.00248533373259363,-0.00258676211795095,-0.00269232988869828,-0.00280220589377045,-0.00291656607931401,-0.00303559334763337,-0.00315947823265050,-0.00328841896701793,-0.00342262186425746,-0.00356230158654602,-0.00370768188667769,-0.00385899519173005,-0.00401648370917940,-0.00418039939853454,-0.00435100466911198,-0.00452857246130423,-0.00471338684787659,-0.00490574368949837,-0.00510595084440846,-0.00531432840017443,-0.00553121007995649,-0.00575694289106643,-0.00599188793043437,-0.00623642125485713,-0.00649093415744373,-0.00675583390569168,-0.00703154429138042,-0.00731850669583034,-0.00761718010894308,-0.00792804264215796,-0.00825159156225830,-0.00858834476863413,-0.00893884097841191,-0.00930364118895133,-0.00968332901574165,-0.0100785120718538,-0.0104898227310524,-0.0109179191696840,-0.0113634863092016,-0.0118272372439665,-0.0123099140233451,-0.0128122888879978,-0.0133351657829461,-0.0138793814300486,-0.0144458065423070,-0.0150353474821507,-0.0156489476081378,-0.0162875887082525,-0.0169522926464771,-0.0176441230365643,-0.0183641867991247,-0.0191136361067379,-0.0198936700657737,-0.0207055367565379,-0.0215505351587875,-0.0224300172286251,-0.0233453901555825,-0.0242981184253588,-0.0252897263580132,-0.0263218003627719,-0.0273959916726740,-0.0285140187866184,-0.0296776703341273,-0.0308888078562886,-0.0321493688817953,-0.0334613698922959,-0.0348269096211440,-0.0362481723928387,-0.0377274315909726,-0.0392670532393113,-0.0408694998900172,-0.0425373344211111,-0.0442732241816013,-0.0460799452608462,-0.0479603868248080,-0.0499175557922560,-0.0519545815664269,-0.0540747210315828,-0.0562813637137172,-0.0585780371507028,-0.0609684124977528,-0.0634563103630303,-0.0660457068110687,-0.0687407396905426,-0.0715457151415633,-0.0744651144374275,-0.0775036009964536,-0.0806660277704041,-0.0839574448592284,-0.0873831074231779,-0.0909484839633490,-0.0946592648314315,-0.0985213711782174,-0.102540964126929,-0.106724454387364,-0.111078512213370,-0.115610077711215,-0.120326371534696,-0.125234906053817,-0.130343496812790,-0.135660274508065,-0.141193697361708,-0.146952563922886,-0.152946026369283,-0.159183604201085,-0.165675198497139,-0.172431106565174,-0.179462037129596,-0.186779126007397,-0.194393952253125,-0.202318554846537,-0.210565449830447,-0.219147647993023,-0.228078672995569,-0.237372580025041,-0.247043974878014,-0.257108033532294,-0.267580522104072,-0.278477817247047,-0.289816926895947,-0.301615511317910,-0.313891904454577,-0.326665135447934,-0.339954950305865,-0.353781833596967,-0.368167030093070,-0.383132566212863,-0.398701271144386,-0.414896797489739,-0.431743641215454,-0.449267160734901,-0.467493594837720,-0.486450079209555,-0.506164661227326,-0.526666312632707,-0.547984939707646,-0.570151390468898,-0.593197458340633,-0.617155881727283,-0.642060338805428,-0.667945436773509,-0.694846694710316,-0.722800519106615,-0.751844170974736,-0.782015723382268,-0.813354008056877,-0.845898549616919,-0.879689485774937,-0.914767471732414,-0.951173566758945,-0.988949100782788,-1.02813551858455,-1.06877419898133,-1.11090624614885,-1.15457224999488,-1.19981201224895,-1.24666423470671,-1.29516616582304,-1.34535320162943,-1.39725843676330,-1.45091216124438,-1.50634129849803,-1.56356878013453,-1.62261285298992,-1.68348631415044,-1.74619566994627,-1.81074021542282,-1.87711103146909,-1.94528989775289,-2.01524812087417,-2.08694527874326,-2.16032788422943,-2.23532797357867,-2.31186162809549,-2.38982744111343,-2.46910494639985,-2.54955302887833,-2.63100834388624,-2.71328377709890,-2.79616698367263,-2.87941905194872,-2.96277334407336,-3.04593457283814,-3.12857818063278,-3.21035009220394,-3.29086691743502,-3.36971668304709,-3.44646017229328,-3.52063294875132,-3.59174813347740,-3.65929999346842,-3.72276838305685,-3.78162405816856,-3.83533485628595,-3.88337270269684,-3.92522136693141,-3.96038485333367,-3.98839626819536,-4.00882696495403,-4.02129573118534,-4.02547774936529,-4.02111304052313,-4.00801408871446,-3.98607234699175,-3.95526334379442,-3.91565014301187,-3.86738496078884,-3.81070880562509,-3.74594908241876,-3.67351518174044,-3.59389215799549,-3.50763267906912,-3.41534750053352,-3.31769477503566,-3.21536854860954,-3.10908681813113,-2.99957952719873,-2.88757686205718,-2.77379817679463,-2.65894183100693,-2.54367616722476,-2.42863179377906,-2.31439527552049,-2.20150427365856,-2.09044412005249,-1.98164576294135,-1.87548498185694,-1.77228274003055,-1.67230652298228,-1.57577250153546,-1.48284835521054,-1.39365659647203,-1.30827824617791,-1.22675672435454,-1.14910183669781,-1.07529375477552,-1.00528690575510,-0.939013704779251,-0.876388079282003,-0.817308749146928,-0.761662239443850,-0.709325613419021,-0.660168922483551,-0.614057377223809,-0.570853249097891,-0.530417516663384,-0.492611273088639,-0.457296913544181,-0.424339122027051,-0.393605677425135,-0.364968098331087,-0.338302145411196,-0.313488199128131,-0.290411529423884,-0.268962472650236,-0.249036529667013,-0.230534397654580,-0.213361946844903,-0.197430152089839,-0.182654987980924,-0.168957295111571,-0.156262624046555,-0.144501062633917,-0.133607051453877,-0.123519191455146,-0.114180047169454,-0.105535948310920,-0.0975367920645343,-0.0901358479270531,-0.0832895665842104,-0.0769573939853330,-0.0711015915003110,-0.0656870628099604,-0.0606811879841351,-0.0560536650419663,-0.0517763591491582,-0.0478231595004708,-0.0441698438437554,-0.0407939505323585,-0.0376746579336396,-0.0347926709821644,-0.0321301146287145,-0.0296704339174392,-0.0273983004044354,-0.0252995246232679,-0.0233609742968377,-0.0215704979974474,-0.0199168539547490,-0.0183896437226383,-0.0169792504197130,-0.0156767812679592,-0.0144740141641009,-0.0133633480318140,-0.0123377567089467,-0.0113907461406493,-0.0105163146599252,-0.00970891614598957,-0.00896342586670373,-0.00827510881978855,-0.00763959039912221,-0.00705282922380812,-0.00651109197746802,-0.00601093011332043,-0.00554915829453773,-0.00512283444098483,-0.00472924126998509,-0.00436586921920279,-0.00403040065299898,-0.00372069525611529,-0.00343477652942070,-0.00317081930356622,-0.00292713819782797,-0.00270217695169661,-0.00249449856526418,-0.00230277618801233,-0.00212578469882541,-0.00196239292682421,-0.00181155646361564,-0.00167231102338183,-0.00154376630850939,-0.00142510034317755,-0.00131555423943386,-0.00121442736283894,-0.00112107286742713,-0.00103489357178299,-0.000955338150754326,-0.000881897618099092,-0.000814102079083057,-0.000751517729991047,-0.000693744090118909,-0.000640411442875966,-0.000591178475062293,-0.000545730096168651,-0.000503775425098052,-0.000465045931097308,-0.000429293717463253,-0.000396289936976935,-0.000365823328407622,-0.000337698866037517,-0.000311736512270677,-0.000287770066276227,-0.000265646101005324,-0.000245222981420934,-0.000226369959055450,-0.000208966334791505,-0.000192900686979414,-0.000178070158840526,-0.000164379799383330,-0.000151741956833096,-0.000140075716748012,-0.000129306384988315,-0.000119365008988126,-0.000110187937107931,-0.000101716410294550,-9.38961871033150e-05,-8.66771955876367e-05,-8.00132130551745e-05,-7.38615705264678e-05,-6.81828790649597e-05,-6.29407778118818e-05,-5.81017015055529e-05,-5.36346649870900e-05,-4.95110655251985e-05,-4.57044989632394e-05,-4.21905915204412e-05,-3.89468429173867e-05,-3.59524829351976e-05,-3.31883379112163e-05,-3.06367085034509e-05,-2.82812561147594e-05,-2.61068979767742e-05,-2.40997112266328e-05,-2.22468433674905e-05,-2.05364297789501e-05,-1.89575184439406e-05,-1.74999987834212e-05,-1.61545380961137e-05,-1.49125208848133e-05,-1.37659940113721e-05,-1.27076160705286e-05,-1.17306098168513e-05,-1.08287190325740e-05,-9.99616872610076e-06,-9.22762782851194e-06,-8.51817494318397e-06,-7.86326731505582e-06,-7.25871118767429e-06,-6.70063549090827e-06,-6.18546658337493e-06,-5.70990577042352e-06,-5.27090765478633e-06,-4.86566126278731e-06,-4.49157172566217e-06,-4.14624351519066e-06,-3.82746534466349e-06,-3.53319595802759e-06,-3.26155102925441e-06,-3.01079122744241e-06,-2.77931067049764e-06,-2.56562721068221e-06,-2.36837244260713e-06,-2.18628343207072e-06,-2.01819394529679e-06,-1.86302789861870e-06,-1.71979158691826e-06,-1.58756768842139e-06,-1.46550976909410e-06,-1.35283600988245e-06,-1.24882504337620e-06,-1.15281084678287e-06,-1.06417857859142e-06,-9.82360637280522e-07,-9.06833164115994e-07,-8.37112490437164e-07,-7.72752251076980e-07,-7.13340275737551e-07,-6.58496035477185e-07,-6.07868477775497e-07,-5.61133306486994e-07,-5.17991372017690e-07,-4.78166284345605e-07,-4.41403136264285e-07,-4.07466393959055e-07,-3.76138953317451e-07,-3.47219974994317e-07,-3.20524440322600e-07,-2.95881374956508e-07,-2.73132960693090e-07,-2.52133425249212e-07,-2.32748542661199e-07,-2.14853967950290e-07,-1.98335237122649e-07,-1.83086434901725e-07,-1.69010139217107e-07,-1.56016033425743e-07,-1.44020906311937e-07,-1.32948041464687e-07,-1.22726551143870e-07,-1.13290876679883e-07,-1.04580621940187e-07,-9.65401647512465e-08,-8.91177132089638e-08,-8.22660828347921e-08,-7.59411422635026e-08,-7.01024793769989e-08,-6.47127906816536e-08,-5.97374372190984e-08,-5.51446110996778e-08,-5.09048359020881e-08,-4.69911332068307e-08,-4.33783009512467e-08,-4.00431909852728e-08,-3.69644870268360e-08,-3.41225381284005e-08,-3.14990811212113e-08,-2.90773516375964e-08,-2.68417510440599e-08,-2.47780684858867e-08};
 float vel_track_d2[500]={0.000926402592348742,0.000964210408819274,0.00100356062501172,0.00104451637958505,0.00108714365469811,0.00113151218039839,0.00117768871438769,0.00122575122820875,0.00127577570070294,0.00132784100291168,0.00138203097639661,0.00143843267366085,0.00149713640343542,0.00155823619523914,0.00162182801663047,0.00168801640431074,0.00175690571159570,0.00182860698389003,0.00190323331427641,0.00198090566957730,0.00206174772961314,0.00214588978364046,0.00223346489977927,0.00232461470426790,0.00241948378523031,0.00251822449740144,0.00262099561319237,0.00272796041331882,0.00283929035593024,0.00295516406186330,0.00307576688163723,0.00320129078155885,0.00333193826926320,0.00346791721449809,0.00360944549892915,0.00375674983930695,0.00391006552843977,0.00406963854684414,0.00423572355075261,0.00440858648536960,0.00458850477365373,0.00477576459976816,0.00497066746518475,0.00517352423590043,0.00538465977738397,0.00560441178751938,0.00583313215859205,0.00607118669537394,0.00631895646527182,0.00657683793405436,0.00684524372841972,0.00712460317318046,0.00741536377327060,0.00771799038352345,0.00803296741838801,0.00836079879699842,0.00870200933828966,0.00905714492252676,0.00942677369584886,0.00981148737899115,0.0102119016887684,0.0106286568003651,0.0110624201599191,0.0115138857820915,0.0119837758609321,0.0124728425097064,0.0129818683148951,0.0135116678113467,0.0140630885827094,0.0146370133916958,0.0152343602179167,0.0158560852842531,0.0165031831245425,0.0171766895373272,0.0178776819567894,0.0186072823779486,0.0193666580314406,0.0201570241437262,0.0209796454620988,0.0218358383393443,0.0227269726184263,0.0236544744878681,0.0246198280466847,0.0256245777760113,0.0266703315659614,0.0277587628600586,0.0288916130846690,0.0300706949642894,0.0312978952161997,0.0325751774165506,0.0339045852929733,0.0352882460730578,0.0367283735982784,0.0382272722134684,0.0397873401316153,0.0414110735130694,0.0431010703174808,0.0448600344572941,0.0466907803112072,0.0485962368506822,0.0505794527160377,0.0526436007255880,0.0547919833453359,0.0570280375731466,0.0593553406683207,0.0617776157125992,0.0642987377635230,0.0669227397846741,0.0696538192421939,0.0724963447856723,0.0754548631819521,0.0785341064786700,0.0817389997800348,0.0850746688422000,0.0885464483631774,0.0921598905217831,0.0959207736495622,0.0998351115844578,0.103909163132914,0.108149442063190,0.112562727427418,0.117156074301421,0.121936824995481,0.126912620726049,0.132091413622095,0.137481479381149,0.143091430283095,0.148930228874918,0.155007201992850,0.161332055540868,0.167914889718396,0.174766214846394,0.181896967926654,0.189318529662892,0.197042742356416,0.205081928253918,0.213448908774643,0.222157024426748,0.231220155422424,0.240652743069396,0.250469812107603,0.260686993625662,0.271320549016087,0.282387394723381,0.293905127845857,0.305892052738572,0.318367208402171,0.331350396994253,0.344862213130286,0.358924074259269,0.373558252014778,0.388787904506202,0.404637109693132,0.421130899660848,0.438295295986053,0.456157345991136,0.474745160050064,0.494087949756090,0.514216067064581,0.535161044208090,0.556955634494177,0.579633853791851,0.603231022635826,0.627783808909137,0.653330270895928,0.679909900611723,0.707563667193840,0.736334060186167,0.766265132425750,0.797402542288772,0.829793594979440,0.863487282430887,0.898534321469822,0.934987189675503,0.972900158419027,1.01232932245468,1.05333262526541,1.09596987941537,1.14030278093775,1.18639491668125,1.23431176345458,1.28412067761089,1.33589087354693,1.38969338942066,1.44560103821323,1.50368834194953,1.56403144676454,1.62670801611373,1.69179709923387,1.75937897154986,1.82953494346484,1.90234713351785,1.97789820156553,2.05627103716908,2.13754839796265,2.22181249229776,2.30914449998978,2.39962402449784,2.49332846941348,2.59033233164606,2.69070640325882,2.79451687352657,2.90182432248873,3.01268259699607,3.12713756026910,3.24522570597983,3.36697262830088,3.49239133989256,3.62148043084567,3.75422206293817,3.89057979550583,4.03049624174830,4.17389055748652,4.32065576845886,4.47065594715737,4.62372325619095,4.77965488222683,4.93820989279969,5.09910605775671,5.26201668777243,5.42656755419779,5.59233396734526,5.75883810389749,5.92554668814663,6.09186914567633,6.25715636126553,6.42070018440788,6.58173383487010,6.73943336609417,6.89292034458650,7.04126589750265,7.18349626695480,7.31859998693687,7.44553676611362,7.56324811633718,7.67066971257194,7.76674540539363,7.85044273386287,7.92076970666733,7.97679253639072,8.01765392990805,8.04259146237069,8.05095549873058,8.04222608104627,8.01602817742891,7.97214469398350,7.91052668758885,7.83130028602375,7.73476992157768,7.62141761125018,7.49189816483753,7.34703036348089,7.18778431599099,7.01526535813823,6.83069500106703,6.63538955007126,6.43073709721914,6.21817363626226,5.99915905439752,5.77515372411430,5.54759635358926,5.31788366201386,5.08735233444957,4.85726358755806,4.62879055104098,4.40300854731712,4.18088824010499,3.96329152588271,3.75096996371388,3.54456548006105,3.34461304596456,3.15154500307091,2.96569671042113,2.78731319294412,2.61655649235576,2.45351344870909,2.29820367339562,2.15058750955111,2.01057381151015,1.87802740955845,1.75277615856406,1.63461749829386,1.52332447888770,1.41865122683804,1.32033784496710,1.22811475444762,1.14170649819578,1.06083503332677,0.985222546177278,0.914593827088361,0.848678244054102,0.787211354850270,0.729936196662173,0.676604290822391,0.626976398256263,0.580823058847768,0.537924945300472,0.498073059334025,0.461068795309161,0.426723893689807,0.394860304179678,0.365309975961847,0.337914590223143,0.312525248093110,0.289002125267834,0.267214102907754,0.247038382910292,0.228360094338909,0.211071896621839,0.195073584129069,0.180271695854106,0.166579133168421,0.153914787970666,0.142203183000622,0.131374125619921,0.121362375968270,0.112107330083933,0.103552718298316,0.0956463190009416,0.0883396876875109,0.0815879010647169,0.0753493158672791,0.0695853419643289,0.0642602292574290,0.0593408678348784,0.0547966008088707,0.0505990492465358,0.0467219485936754,0.0431409959948947,0.0398337079094979,0.0367792874452766,0.0339585008394261,0.0313535625359185,0.0289480283282018,0.0267266960636281,0.0246755134178933,0.0227814922812986,0.0210326293198504,0.0194178322919791,0.0179268517334075,0.0165502176395771,0.0152791807982444,0.0141056584476162,0.0130221839549360,0.0120218602266409,0.0110983165890755,0.0102456688819697,0.00945848253997017,0.00873173843840558,0.00806080130599796,0.00744139051223058,0.00686955305884140,0.00634163860713244,0.00585427639565594,0.00540435390339322,0.00498899713052836,0.00460555237602467,0.00425156939765081,0.00392478585364842,0.00362311292723128,0.00334462204676367,0.00308753261701877,0.00285020068635511,0.00263110847886772,0.00242885472567789,0.00224214573485426,0.00206978714356598,0.00191067630150865,0.00176379523619818,0.00162820415816611,0.00150303545998209,0.00138748818023782,0.00128082288575193,0.00118235695012459,0.00109146019233730,0.00100755085019610,0.000930091862194615,0.000858587434926506,0.000792579873953869,0.000731646656815244,0.000675397732075034,0.000623473024541354,0.000575540132552455,0.000531292202010647,0.000490445962841868,0.000452739918110900,0.000417932669583010,0.000385801373958827,0.000356140317681053,0.000328759598766659,0.000303483913666192,0.000280151433496023,0.000258612769976629,0.000238730017976252,0.000220375874215861,0.000203432820589100,0.000187792374206630,0.000173354391175273,0.000160026426110349,0.000147723141052936,0.000136365758129919,0.000125881555623764,0.000116203403011106,0.000107269329974180,9.90221310503969e-05,9.14089979264787e-05,8.43811830408825e-05,7.78936858347734e-05,7.19049658703952e-05,6.63766758224327e-05,6.12734170069018e-05,5.65625122295188e-05,5.22137959535485e-05,4.81994224532656e-05,4.44936867349810e-05,4.10728595579002e-05,3.79150368878811e-05,3.49999975668425e-05,3.23090761922273e-05,2.98250417696266e-05,2.75319880227443e-05,2.54152321410572e-05,2.34612196337025e-05,2.16574380651480e-05,1.99923374522015e-05,1.84552556570239e-05,1.70363498863679e-05,1.57265346301116e-05,1.45174223753486e-05,1.34012709818165e-05,1.23709331667499e-05,1.14198115408470e-05,1.05418153095727e-05,9.73132252557463e-06,8.98314345132434e-06,8.29248703038132e-06,7.65493068932699e-06,7.06639191605518e-06,6.52310205850881e-06,6.02158245488482e-06,5.55862134099527e-06,5.13125442136442e-06,4.73674488521425e-06,4.37256686414145e-06,4.03638789059357e-06,3.72605579723739e-06,3.43958317383652e-06,3.17513537684278e-06,2.93101953818820e-06,2.70567201976490e-06,2.49765008675240e-06,2.30562169356574e-06,2.12835715718285e-06,1.96472127456104e-06,1.81366632823199e-06,1.67422498087433e-06,1.54550450215396e-06,1.42668055147510e-06,1.31699207095437e-06,1.21573695555099e-06,1.12226661297399e-06,1.03598274403538e-06,9.56332568691209e-07,8.82806272528569e-07,8.14932787918110e-07,7.52277906634902e-07,6.94439949988635e-07,6.41048880645201e-07,5.91762749913016e-07,5.46265921386180e-07,5.04266850498425e-07,4.65497085322397e-07,4.29707935900581e-07,3.96670474245298e-07,3.66172869803449e-07,3.38020278434215e-07,3.12032066851486e-07,2.88041812623874e-07,2.65896082929373e-07,2.45453102287740e-07,2.26581753359767e-07,2.09161243880374e-07,1.93080329502493e-07,1.78235426417928e-07,1.64532165669584e-07,1.51882284527005e-07,1.40204958753998e-07,1.29425581363307e-07,1.19474874438197e-07,1.10289222199356e-07,1.01809671804176e-07,9.39822664136614e-08,8.67566019024935e-08,8.00863819705455e-08,7.39289740536719e-08,6.82450762568010e-08,6.29981622424225e-08,5.81547032751928e-08,5.36835020881199e-08,4.95561369717734e-08};
 //*********velocity desired arry***********//

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_ADC1_Init(void);
static void MX_ADC2_Init(void);
static void MX_TIM3_Init(void);
static void MX_TIM4_Init(void);
static void MX_TIM5_Init(void);
static void MX_USART3_UART_Init(void);
static void MX_TIM9_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
#include"impl_tsk.h"

int _write(int file, char *ptr, int len){

	/* Implement your write code here, this is used by puts and printf for example */
	int i=0;
	for (i=0; i<len; i++){
		ITM_SendChar((ptr++));
	}
	return len;

}

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef* htim)
{
	  timeblock+=65535;
}

void Motor_control_1(int PWM,int cap) {
  if (PWM >= 0) {
    if (abs(PWM) > cap) {
      PWM = cap;
    }
    HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12, GPIO_PIN_RESET);
    TIM4->CCR3 = abs(PWM);
    HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_3);
  }
  else if (PWM < 0) {
    if (abs(PWM) > cap) {
      PWM = cap;
    }
    HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12, GPIO_PIN_SET);
    TIM4->CCR3 = abs(PWM);
	HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_3);
  }
}

void Motor_control_2(int PWM,int cap) {
  if (PWM >= 0) {
    if (abs(PWM) > cap) {
      PWM = cap;
    }
    HAL_GPIO_WritePin(GPIOD, GPIO_PIN_13, GPIO_PIN_SET);
    TIM4->CCR4 = abs(PWM);
    HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_4);
  }
  else if (PWM < 0) {
    if (abs(PWM) > cap) {
      PWM = cap;
    }
    HAL_GPIO_WritePin(GPIOD, GPIO_PIN_13, GPIO_PIN_RESET);
    TIM4->CCR4 = abs(PWM);
	HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_4);
  }
}
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */
	char msg[10];
  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */
  ITM_Port32(31)=1;
  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_ADC1_Init();
  MX_ADC2_Init();
  MX_TIM3_Init();
  MX_TIM4_Init();
  MX_TIM5_Init();
  MX_USART3_UART_Init();
  MX_TIM9_Init();
  /* USER CODE BEGIN 2 */
  ITM_Port32(31) = 2;

  HAL_TIM_Encoder_Start_IT(&htim3, TIM_CHANNEL_ALL);
    HAL_TIM_Encoder_Start_IT(&htim5, TIM_CHANNEL_ALL);
    HAL_TIM_Base_Start_IT(&htim9);
  //set timer to some intial value to remove the bounce
    TIM3->CNT=32767;
    TIM5->CNT=32767;

    for(int i=0;i<200;i++){
    	  HAL_ADC_Start(&hadc1);
    	  HAL_ADC_PollForConversion(&hadc1, HAL_MAX_DELAY);
    	  raw = HAL_ADC_GetValue(&hadc1);
    	  inivolt+=(raw*3.3/ 4096);
      }
      inivolt=inivolt/200;

      for(int i=0;i<200;i++){
       	  HAL_ADC_Start(&hadc2);
       	  HAL_ADC_PollForConversion(&hadc2, HAL_MAX_DELAY);
       	  raw = HAL_ADC_GetValue(&hadc2);
       	  inivolt2+=(raw*3.3/ 4096);
	 }
	 inivolt2=inivolt2/200;

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */

////////////////////////////////////////////////current_start//////////////////////////////////////////////
//cuiwali motor2
// ADC conversion
	HAL_ADC_Start(&hadc1);
	HAL_ADC_PollForConversion(&hadc1, HAL_MAX_DELAY);
	raw = HAL_ADC_GetValue(&hadc1);
	volt=(raw*3.3/ 4096);
	current2=(inivolt-volt)*10  + 0.2;
// Kalman Filtering
	old_estimate2=estimate2;
    measurement2=current2; // current measurement
    kalman_gain2= estimate_variance2/(estimate_variance2+measurement_variance2); // Kalman gain
    estimate2=estimate2 + kalman_gain2*(measurement2-estimate2); // update in estimate
    estimate_variance2=(1-kalman_gain2)*(estimate_variance2) + fabs(old_estimate2-estimate2)*estimate_measurement_weight2;  //update in estimate variance


// control loop
	  E_rror_m2 = D_current2 - estimate2;
	  P_wm_m2=kp2*E_rror_m2;
	  Motor_control_2(P_wm_m2,1000);



//robokits motor1
// ADC conversion
	HAL_ADC_Start(&hadc2);
	HAL_ADC_PollForConversion(&hadc2, HAL_MAX_DELAY);
	raw2 = HAL_ADC_GetValue(&hadc2);
	volt2=(raw2*3.3/ 4096);
	current=(inivolt2-volt2)*10;
// Kalman Filtering
	old_estimate=estimate;
    measurement=current; // current measurement
    kalman_gain= estimate_variance/(estimate_variance+measurement_variance); // Kalman gain
    estimate=estimate + kalman_gain*(measurement-estimate); // update in estimate
	estimate_variance=(1-kalman_gain)*(estimate_variance) + fabs(old_estimate-estimate)*estimate_measurement_weight;  //update in estimate
// control loop
	  E_rror_m1 = D_current - estimate;
	  P_wm_m1=kp*E_rror_m1;
	  Motor_control_1(P_wm_m1,1000);
////////////////////////////////////////////////current_end//////////////////////////////////////////////
////////////////////////////////////////////////th and thdot_start///////////////////////////////////////
//read encoder
	  raw_enc1=(TIM3->CNT);
	  raw_enc2=(TIM5->CNT);
	if(raw_enc1 != prev_enc1){
		real_enc1+=(raw_enc1-prev_enc1);
		prev_enc1=raw_enc1;
	}
	if(raw_enc2 != prev_enc2){
		real_enc2+=(raw_enc2-prev_enc2);
		prev_enc2=raw_enc2;
	}

	  eth2=(real_enc1/(2*4096))*6.28;
	  eth1=-(real_enc2/2000)*6.28;

	  th1=eth1+ spth1;
	  th2=eth2-th1+spth2 + spth1;


	  //////////////th_dot
	  now_time=__HAL_TIM_GET_COUNTER(&htim9)+timeblock;
	  D_t=now_time-prev_time;
	  DE_rrorm1=((th1-prev_th1)/D_t)*10E6;
	  DE_rrorm2=((th2-prev_th2)/D_t)*10E6;

	  prev_th1=th1;
	  prev_th2=th2;
	  prev_time=now_time;


	  // Kalman Filtering
		old_estimate3=estimate3;
		measurement3=DE_rrorm1; // current measurement
		kalman_gain3= estimate_variance3/(estimate_variance3+measurement_variance3); // Kalman gain
		estimate3=estimate3 + kalman_gain3*(measurement3-estimate3); // update in estimate
		estimate_variance3=(1-kalman_gain3)*(estimate_variance3) + fabs(old_estimate3-estimate3)*estimate_measurement_weight3;  //update in estimate variance

		// Kalman Filtering
		old_estimate4=estimate4;
		measurement4=DE_rrorm2; // current measurement
		kalman_gain4= estimate_variance4/(estimate_variance4+measurement_variance4); // Kalman gain
		estimate4=estimate4 + kalman_gain4*(measurement4-estimate4); // update in estimate
		estimate_variance4=(1-kalman_gain4)*(estimate_variance4) + fabs(old_estimate4-estimate4)*estimate_measurement_weight4;  //update in estimate variance

////////////////////////////////////////////////th and thdot_end///////////////////////////////////////

/////////////////////////////////tracj_sec_strt////////////////////////////////////////////////////
		data+=0.01;
	    arr_indx=data;

////////////////////////////////me implemetation////////////////////////////////////////////////////
//	    if(data>=500){
//	    	if(flag==0){
//	    		t1ini=th1;
//	    		t2ini=th2;
//	    		t1fi=1.57;
//	    		t2fi=0;
//	    		flag=1;
//	    	}
//	    	int arr_indx_1=arr_indx-500;
//	    	thd1=t1ini + 3*(t1fi-t1ini)*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1] - 2*(t1fi-t1ini)*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1];
//	    	thd2=t2ini + 3*(t2fi-t2ini)*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1] - 2*(t2fi-t2ini)*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1];
//	    	vel_DError_d1=6*(t1fi-t1ini)*trac_tvect[arr_indx_1]-6*(t1fi-t1ini)*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1];
//	    	vel_DError_d2=6*(t2fi-t2ini)*trac_tvect[arr_indx_1]-6*(t2fi-t2ini)*trac_tvect[arr_indx_1]*trac_tvect[arr_indx_1];
//
//	    	if(data>=1000){
//	    		data=1;
//	    		Motor_control_1(0,800);
//	    		Motor_control_2(0,800);
//	    		flag=0;
//	    		HAL_Delay(1000);
//	    	}
//	    }
//	    else{
//	    	thd1=thd1_trac[arr_indx];
//	    	thd2=thd2_trac[arr_indx];
//	    	vel_DError_d1=vel_track_d1[arr_indx];
//	    	vel_DError_d2=vel_track_d2[arr_indx];
//	    }
///////////////////////////////////////////////////////////////////////////////////////////////////////
//	    D_current= (1*(thd1-th1))*10+ (vel_DError_d1-estimate3)*0.001;							/////
//	   	D_current2= (1*(thd2-th2))*10 +(vel_DError_d2-estimate4)*0.001;							/////
//////////////////////////////me implemetation done////////////////////////////////////////////////////

//	  D_current= (1*(thd1-th1))*10+ (vel_DError_d1-estimate3)*0.000;
//	  D_current2= (1*(thd2-th2))*10 +(vel_DError_d2-estimate4)*0.000;

/////////////////////////////////tracj_sec_clsd////////////////////////////////////////////////////
	  sprintf(msg, "%d\r\n",arr_indx);
	  HAL_UART_Transmit(&huart3, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);


//*************************implementation tsk1**************************//

	  float des_m1_crnt=0;
	  float des_m2_crnt=0;
	  motor_trqctrl(&des_m1_crnt,&des_m2_crnt);
	  D_current=des_m1_crnt;
	  D_current2=des_m2_crnt;

//*************************implementation tsk1 end**************************//

//*************************implementation tsk2**************************//
//	  float d_theta1=0;
//	  float d_theta2=0;
//	  float vd_theta1=0;
//	  float vd_theta2=0;
//	  traj_ctrl(&d_theta1,&d_theta2,&vd_theta1,&vd_theta2);
//	  thd1=d_theta1;
//	  thd2=d_theta2;
//	  vel_DError_d1=vd_theta1;
//	  vel_DError_d2=vd_theta2;
//	  D_current= (1*(thd1-th1))*10+ (vel_DError_d1-estimate3)*0.000;
//	  D_current2= (1*(thd2-th2))*10 +(vel_DError_d2-estimate4)*0.000;

//*************************implementation tsk2 end**************************//

	  ////////////////////////////test zone///////////////////////////
//	  Motor_control_1(-100,800);
//	  Motor_control_2(100,800);
//	  D_current=0;//m1
//	  D_current2=0;//m2
//    D_current= (1*(0-th1))*10;
//    D_current2= (1*(0-th2))*10;
	  ////////////////////////////test zone///////////////////////////

  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 8;
  RCC_OscInitStruct.PLL.PLLN = 336;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 7;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief ADC1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_ADC1_Init(void)
{

  /* USER CODE BEGIN ADC1_Init 0 */

  /* USER CODE END ADC1_Init 0 */

  ADC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN ADC1_Init 1 */

  /* USER CODE END ADC1_Init 1 */

  /** Configure the global features of the ADC (Clock, Resolution, Data Alignment and number of conversion)
  */
  hadc1.Instance = ADC1;
  hadc1.Init.ClockPrescaler = ADC_CLOCK_SYNC_PCLK_DIV4;
  hadc1.Init.Resolution = ADC_RESOLUTION_12B;
  hadc1.Init.ScanConvMode = DISABLE;
  hadc1.Init.ContinuousConvMode = DISABLE;
  hadc1.Init.DiscontinuousConvMode = DISABLE;
  hadc1.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  hadc1.Init.ExternalTrigConv = ADC_SOFTWARE_START;
  hadc1.Init.DataAlign = ADC_DATAALIGN_RIGHT;
  hadc1.Init.NbrOfConversion = 1;
  hadc1.Init.DMAContinuousRequests = DISABLE;
  hadc1.Init.EOCSelection = ADC_EOC_SINGLE_CONV;
  if (HAL_ADC_Init(&hadc1) != HAL_OK)
  {
    Error_Handler();
  }

  /** Configure for the selected ADC regular channel its corresponding rank in the sequencer and its sample time.
  */
  sConfig.Channel = ADC_CHANNEL_14;
  sConfig.Rank = 1;
  sConfig.SamplingTime = ADC_SAMPLETIME_3CYCLES;
  if (HAL_ADC_ConfigChannel(&hadc1, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN ADC1_Init 2 */

  /* USER CODE END ADC1_Init 2 */

}

/**
  * @brief ADC2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_ADC2_Init(void)
{

  /* USER CODE BEGIN ADC2_Init 0 */

  /* USER CODE END ADC2_Init 0 */

  ADC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN ADC2_Init 1 */

  /* USER CODE END ADC2_Init 1 */

  /** Configure the global features of the ADC (Clock, Resolution, Data Alignment and number of conversion)
  */
  hadc2.Instance = ADC2;
  hadc2.Init.ClockPrescaler = ADC_CLOCK_SYNC_PCLK_DIV4;
  hadc2.Init.Resolution = ADC_RESOLUTION_12B;
  hadc2.Init.ScanConvMode = DISABLE;
  hadc2.Init.ContinuousConvMode = DISABLE;
  hadc2.Init.DiscontinuousConvMode = DISABLE;
  hadc2.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  hadc2.Init.ExternalTrigConv = ADC_SOFTWARE_START;
  hadc2.Init.DataAlign = ADC_DATAALIGN_RIGHT;
  hadc2.Init.NbrOfConversion = 1;
  hadc2.Init.DMAContinuousRequests = DISABLE;
  hadc2.Init.EOCSelection = ADC_EOC_SINGLE_CONV;
  if (HAL_ADC_Init(&hadc2) != HAL_OK)
  {
    Error_Handler();
  }

  /** Configure for the selected ADC regular channel its corresponding rank in the sequencer and its sample time.
  */
  sConfig.Channel = ADC_CHANNEL_8;
  sConfig.Rank = 1;
  sConfig.SamplingTime = ADC_SAMPLETIME_3CYCLES;
  if (HAL_ADC_ConfigChannel(&hadc2, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN ADC2_Init 2 */

  /* USER CODE END ADC2_Init 2 */

}

/**
  * @brief TIM3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM3_Init(void)
{

  /* USER CODE BEGIN TIM3_Init 0 */

  /* USER CODE END TIM3_Init 0 */

  TIM_Encoder_InitTypeDef sConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM3_Init 1 */

  /* USER CODE END TIM3_Init 1 */
  htim3.Instance = TIM3;
  htim3.Init.Prescaler = 0;
  htim3.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim3.Init.Period = 65535;
  htim3.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim3.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  sConfig.EncoderMode = TIM_ENCODERMODE_TI1;
  sConfig.IC1Polarity = TIM_ICPOLARITY_RISING;
  sConfig.IC1Selection = TIM_ICSELECTION_DIRECTTI;
  sConfig.IC1Prescaler = TIM_ICPSC_DIV1;
  sConfig.IC1Filter = 0;
  sConfig.IC2Polarity = TIM_ICPOLARITY_RISING;
  sConfig.IC2Selection = TIM_ICSELECTION_DIRECTTI;
  sConfig.IC2Prescaler = TIM_ICPSC_DIV1;
  sConfig.IC2Filter = 0;
  if (HAL_TIM_Encoder_Init(&htim3, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim3, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM3_Init 2 */

  /* USER CODE END TIM3_Init 2 */

}

/**
  * @brief TIM4 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM4_Init(void)
{

  /* USER CODE BEGIN TIM4_Init 0 */

  /* USER CODE END TIM4_Init 0 */

  TIM_MasterConfigTypeDef sMasterConfig = {0};
  TIM_OC_InitTypeDef sConfigOC = {0};

  /* USER CODE BEGIN TIM4_Init 1 */

  /* USER CODE END TIM4_Init 1 */
  htim4.Instance = TIM4;
  htim4.Init.Prescaler = 84;
  htim4.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim4.Init.Period = 1000;
  htim4.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim4.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_PWM_Init(&htim4) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim4, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sConfigOC.OCMode = TIM_OCMODE_PWM1;
  sConfigOC.Pulse = 0;
  sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
  sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
  if (HAL_TIM_PWM_ConfigChannel(&htim4, &sConfigOC, TIM_CHANNEL_3) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_TIM_PWM_ConfigChannel(&htim4, &sConfigOC, TIM_CHANNEL_4) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM4_Init 2 */

  /* USER CODE END TIM4_Init 2 */
  HAL_TIM_MspPostInit(&htim4);

}

/**
  * @brief TIM5 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM5_Init(void)
{

  /* USER CODE BEGIN TIM5_Init 0 */

  /* USER CODE END TIM5_Init 0 */

  TIM_Encoder_InitTypeDef sConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM5_Init 1 */

  /* USER CODE END TIM5_Init 1 */
  htim5.Instance = TIM5;
  htim5.Init.Prescaler = 0;
  htim5.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim5.Init.Period = 65535;
  htim5.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim5.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  sConfig.EncoderMode = TIM_ENCODERMODE_TI1;
  sConfig.IC1Polarity = TIM_ICPOLARITY_RISING;
  sConfig.IC1Selection = TIM_ICSELECTION_DIRECTTI;
  sConfig.IC1Prescaler = TIM_ICPSC_DIV1;
  sConfig.IC1Filter = 0;
  sConfig.IC2Polarity = TIM_ICPOLARITY_RISING;
  sConfig.IC2Selection = TIM_ICSELECTION_DIRECTTI;
  sConfig.IC2Prescaler = TIM_ICPSC_DIV1;
  sConfig.IC2Filter = 0;
  if (HAL_TIM_Encoder_Init(&htim5, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim5, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM5_Init 2 */

  /* USER CODE END TIM5_Init 2 */

}

/**
  * @brief TIM9 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM9_Init(void)
{

  /* USER CODE BEGIN TIM9_Init 0 */

  /* USER CODE END TIM9_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};

  /* USER CODE BEGIN TIM9_Init 1 */

  /* USER CODE END TIM9_Init 1 */
  htim9.Instance = TIM9;
  htim9.Init.Prescaler = 168;
  htim9.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim9.Init.Period = 0xffff-1;
  htim9.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim9.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim9) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim9, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM9_Init 2 */

  /* USER CODE END TIM9_Init 2 */

}

/**
  * @brief USART3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART3_UART_Init(void)
{

  /* USER CODE BEGIN USART3_Init 0 */

  /* USER CODE END USART3_Init 0 */

  /* USER CODE BEGIN USART3_Init 1 */

  /* USER CODE END USART3_Init 1 */
  huart3.Instance = USART3;
  huart3.Init.BaudRate = 115200;
  huart3.Init.WordLength = UART_WORDLENGTH_8B;
  huart3.Init.StopBits = UART_STOPBITS_1;
  huart3.Init.Parity = UART_PARITY_NONE;
  huart3.Init.Mode = UART_MODE_TX_RX;
  huart3.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart3.Init.OverSampling = UART_OVERSAMPLING_16;
  if (HAL_UART_Init(&huart3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART3_Init 2 */

  /* USER CODE END USART3_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();
  __HAL_RCC_GPIOD_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOD, GPIO_PIN_12|GPIO_PIN_13, GPIO_PIN_RESET);

  /*Configure GPIO pins : PD12 PD13 */
  GPIO_InitStruct.Pin = GPIO_PIN_12|GPIO_PIN_13;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_HIGH;
  HAL_GPIO_Init(GPIOD, &GPIO_InitStruct);

}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
